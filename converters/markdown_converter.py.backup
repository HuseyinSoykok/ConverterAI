"""
Markdown converter - handles all Markdown conversions
"""
import time
from pathlib import Path
from typing import Optional
import markdown2
from bs4 import BeautifulSoup
from docx import Document
from docx.shared import Inches, Pt
from docx.enum.style import WD_STYLE_TYPE
import re

from converters.base import BaseConverter, ConversionResult
from utils.logger import logger


class MarkdownConverter(BaseConverter):
    """Convert Markdown to other formats"""
    
    def convert(self, input_file: str, output_file: str, **options) -> ConversionResult:
        """Route to appropriate conversion method"""
        output_format = Path(output_file).suffix.lower().lstrip('.')
        
        start_time = time.time()
        
        # Validate files
        error = self._validate_files(input_file, output_file)
        if error:
            return self._create_error_result(input_file, error, 'markdown', output_format)
        
        try:
            if output_format == 'pdf':
                result = self._markdown_to_pdf(input_file, output_file, **options)
            elif output_format in ['docx', 'doc']:
                result = self._markdown_to_docx(input_file, output_file, **options)
            elif output_format in ['html', 'htm']:
                result = self._markdown_to_html(input_file, output_file, **options)
            else:
                return self._create_error_result(
                    input_file,
                    f"Unsupported output format: {output_format}",
                    'markdown',
                    output_format
                )
            
            processing_time = time.time() - start_time
            result.processing_time = processing_time
            return result
            
        except Exception as e:
            logger.error(f"Markdown conversion failed: {e}", exc_info=True)
            return self._create_error_result(input_file, str(e), 'markdown', output_format)
    
    def _markdown_to_html(self, input_file: str, output_file: str, **options) -> ConversionResult:
        """Convert Markdown to HTML using markdown2 with all extras"""
        logger.info(f"Converting Markdown to HTML: {input_file} -> {output_file}")
        
        try:
            # Read markdown file with proper encoding
            with open(input_file, 'r', encoding='utf-8') as f:
                md_content = f.read()
            
            # Convert to HTML with markdown2 and ALL extras (like markdown-it)
            # This provides: tables, fenced-code, footnotes, strike, task-lists, etc.
            html_body = markdown2.markdown(
                md_content,
                extras=[
                    "tables",  # GitHub-style tables
                    "fenced-code-blocks",  # ```code``` blocks
                    "code-friendly",  # Better code handling
                    "cuddled-lists",  # Lists without blank lines
                    "footnotes",  # [^1] footnotes
                    "header-ids",  # Add IDs to headers
                    "strike",  # ~~strikethrough~~
                    "task_list",  # - [ ] task lists
                    "break-on-newline",  # Line breaks
                    "target-blank-links",  # Open links in new tab
                    "toc",  # Table of contents
                ]
            )
            
            # Read our professional export CSS
            import os
            css_path = os.path.join(os.path.dirname(__file__), '..', 'static', 'css', 'export.css')
            try:
                with open(css_path, 'r', encoding='utf-8') as css_file:
                    custom_css = css_file.read()
            except:
                # Fallback inline CSS if file not found
                custom_css = self._get_fallback_css()
            
            # Create full HTML document with professional styling
            html_content = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Converted Markdown</title>
    <style>
{custom_css}
    </style>
</head>
<body>
{html_body}
</body>
</html>"""
            color: #1a1a1a;
        }}
        h1 {{
            font-size: 2.5em;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 12px;
            margin-bottom: 24px;
        }}
        h2 {{
            font-size: 2em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }}
        h3 {{ font-size: 1.5em; }}
        h4 {{ font-size: 1.25em; }}
        h5 {{ font-size: 1.1em; }}
        h6 {{ font-size: 1em; }}
        p {{
            margin: 16px 0;
            text-align: justify;
        }}
        a {{
            color: #0066cc;
            text-decoration: none;
        }}
        a:hover {{
            text-decoration: underline;
        }}
        ul, ol {{
            margin: 16px 0;
            padding-left: 30px;
        }}
        li {{
            margin: 8px 0;
        }}
        code {{
            background-color: #f4f4f4;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #c7254e;
        }}
        pre {{
            background-color: #f6f8fa;
            padding: 20px;
            overflow: auto;
            border-radius: 6px;
            line-height: 1.5;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
        }}
        pre code {{
            background-color: transparent;
            padding: 0;
            color: inherit;
        }}
        table {{
            border-collapse: collapse;
            width: 100%;
            margin: 24px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }}
        table, th, td {{
            border: 1px solid #ddd;
        }}
        th, td {{
            padding: 14px 18px;
            text-align: left;
        }}
        th {{
            background-color: #0066cc;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }}
        tr:nth-child(even) {{
            background-color: #f9f9f9;
        }}
        tr:hover {{
            background-color: #f0f7ff;
        }}
        blockquote {{
            border-left: 4px solid #0066cc;
            margin: 20px 0;
            padding: 12px 20px;
            background-color: #f9f9f9;
            color: #666;
        }}
        hr {{
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 32px 0;
        }}
        img {{
            max-width: 100%;
            height: auto;
            margin: 20px 0;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }}
        strong {{
            font-weight: 600;
            color: #1a1a1a;
        }}
        em {{
            font-style: italic;
            color: #444;
        }}
        @media print {{
            body {{ background: white; padding: 0; }}
            .content {{ box-shadow: none; padding: 40px; }}
        }}
        @media (max-width: 768px) {{
            .content {{ padding: 30px 20px; }}
            body {{ padding: 20px 10px; }}
            table {{ font-size: 0.9em; }}
            th, td {{ padding: 10px 12px; }}
        }}
    </style>
</head>
<body>
    <div class="content">
{html_body}
    </div>
</body>
</html>"""
            
            # Write to file with UTF-8-sig encoding
            with open(output_file, 'w', encoding='utf-8-sig') as f:
                f.write(html_content)
            
            logger.info(f"Successfully converted Markdown to HTML: {output_file}")
            return self._create_success_result(
                input_file,
                output_file,
                'markdown',
                'html'
            )
            
        except Exception as e:
            logger.error(f"Markdown to HTML conversion failed: {e}")
            raise
    
    def _markdown_to_pdf(self, input_file: str, output_file: str, **options) -> ConversionResult:
        """Convert Markdown to PDF"""
        logger.info(f"Converting Markdown to PDF: {input_file} -> {output_file}")
        
        try:
            # First convert to HTML
            temp_html = input_file + '.temp.html'
            result = self._markdown_to_html(input_file, temp_html, **options)
            
            if not result.success:
                return result
            
            # Convert HTML to PDF
            try:
                from weasyprint import HTML
                HTML(temp_html).write_pdf(output_file)
                logger.info("Used WeasyPrint for Markdown to PDF conversion")
            except (ImportError, OSError) as e:
                # Fallback to reportlab
                logger.warning(f"WeasyPrint not available ({e}), using reportlab fallback")
                from reportlab.lib.pagesizes import letter
                from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer
                from reportlab.lib.styles import getSampleStyleSheet
                from reportlab.lib.units import inch
                
                # Read HTML and extract text
                with open(temp_html, 'r', encoding='utf-8') as f:
                    html_content = f.read()
                
                soup = BeautifulSoup(html_content, 'html.parser')
                
                # Create PDF
                doc = SimpleDocTemplate(output_file, pagesize=letter)
                styles = getSampleStyleSheet()
                story = []
                
                # Get text content
                text = soup.get_text()
                
                # Add paragraphs
                for line in text.split('\n'):
                    if line.strip():
                        story.append(Paragraph(line.strip(), styles['Normal']))
                        story.append(Spacer(1, 0.1 * inch))
                
                doc.build(story)
                logger.info("Used ReportLab for Markdown to PDF conversion")
            
            # Clean up temp file
            Path(temp_html).unlink(missing_ok=True)
            
            logger.info(f"Successfully converted Markdown to PDF: {output_file}")
            return self._create_success_result(
                input_file,
                output_file,
                'markdown',
                'pdf'
            )
            
        except Exception as e:
            logger.error(f"Markdown to PDF conversion failed: {e}")
            # Clean up temp file on error
            Path(temp_html).unlink(missing_ok=True)
            raise
    
    def _markdown_to_docx(self, input_file: str, output_file: str, **options) -> ConversionResult:
        """Convert Markdown to DOCX"""
        logger.info(f"Converting Markdown to DOCX: {input_file} -> {output_file}")
        
        try:
            # Read markdown file
            with open(input_file, 'r', encoding='utf-8') as f:
                md_content = f.read()
            
            # Create DOCX document
            doc = Document()
            
            # Parse markdown line by line
            lines = md_content.split('\n')
            i = 0
            
            while i < len(lines):
                line = lines[i]
                
                # Heading
                if line.startswith('#'):
                    level = len(line) - len(line.lstrip('#'))
                    text = line.lstrip('#').strip()
                    
                    if text:
                        para = doc.add_paragraph(text)
                        if level == 1:
                            para.style = 'Heading 1'
                        elif level == 2:
                            para.style = 'Heading 2'
                        elif level == 3:
                            para.style = 'Heading 3'
                        else:
                            para.style = 'Heading 4'
                
                # Code block
                elif line.startswith('```'):
                    code_lines = []
                    i += 1
                    while i < len(lines) and not lines[i].startswith('```'):
                        code_lines.append(lines[i])
                        i += 1
                    
                    if code_lines:
                        code_text = '\n'.join(code_lines)
                        para = doc.add_paragraph(code_text)
                        para.style = 'No Spacing'
                        # Set monospace font
                        for run in para.runs:
                            run.font.name = 'Courier New'
                            run.font.size = Pt(10)
                
                # Bullet list
                elif line.strip().startswith(('- ', '* ', '+ ')):
                    text = line.strip()[2:].strip()
                    doc.add_paragraph(text, style='List Bullet')
                
                # Numbered list
                elif re.match(r'^\d+\.\s', line.strip()):
                    text = re.sub(r'^\d+\.\s', '', line.strip())
                    doc.add_paragraph(text, style='List Number')
                
                # Regular paragraph
                elif line.strip():
                    doc.add_paragraph(line.strip())
                
                i += 1
            
            # Save document
            doc.save(output_file)
            
            logger.info(f"Successfully converted Markdown to DOCX: {output_file}")
            return self._create_success_result(
                input_file,
                output_file,
                'markdown',
                'docx'
            )
            
        except Exception as e:
            logger.error(f"Markdown to DOCX conversion failed: {e}")
            raise
